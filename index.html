<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دار فريدة كوكب التراث</title>
    
    <!-- تحميل Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- تكوين ألوان Tailwind المخصصة -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            bg: '#F5F5DC',        // بيج تراثي
                            primary: '#5C3A21',   // بني داكن
                            gold: '#C9A24D',      // ذهبي معتق
                            accent: '#7B2D26',    // عنابي تراثي
                            success: '#6B8E23',   // أخضر زيتي
                            text: '#3E2723',      // بني غامق للنصوص
                        }
                    },
                    fontFamily: {
                        tajawal: ['Tajawal', 'sans-serif'],
                        amiri: ['Amiri', 'serif'],
                    }
                }
            }
        }
    </script>

    <!-- تحميل الخطوط والأيقونات -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #F5F5DC; color: #3E2723; }
        h1, h2, h3, .font-heading { font-family: 'Amiri', serif; }
        
        /* تأثيرات الحركة */
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .slide-up { animation: slideUp 0.4s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* تنسيقات الطباعة */
        @media print {
            @page { size: A4; margin: 10mm; }
            body { background-color: white !important; }
            
            /* إخفاء كل محتويات الصفحة */
            body * { visibility: hidden; }
            
            /* إخفاء العناصر الأساسية للتطبيق لتجنب تداخل المساحات */
            header, #app { display: none !important; }

            /* إظهار منطقة الطباعة فقط */
            #printable-area, #printable-area * { 
                visibility: visible !important; 
                display: block !important; /* تجاوز display: none */
            }
            
            #printable-area { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                height: auto;
                background: white; 
                padding: 0; 
                color: black; 
                font-size: 12px; 
                z-index: 9999;
            }
            
            /* تنسيقات خاصة للجدول داخل الطباعة لضمان العرض */
            #printable-area table { display: table !important; width: 100% !important; }
            #printable-area thead { display: table-header-group !important; }
            #printable-area tbody { display: table-row-group !important; }
            #printable-area tr { display: table-row !important; }
            #printable-area td, #printable-area th { display: table-cell !important; }
            
            /* تنسيقات فليكس داخل الطباعة */
            #printable-area .flex-print { display: flex !important; justify-content: space-between; }

            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="min-h-screen pb-10">

    <!-- الرأس (Header) -->
    <header class="shadow-lg mb-6 sticky top-0 z-50 bg-brand-primary print:hidden">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <!-- الشعار -->
                <div class="w-12 h-12 rounded-full overflow-hidden border-2 border-brand-gold bg-brand-bg flex items-center justify-center">
                    <img src="icon.jpeg" alt="شعار" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                    <span class="font-heading text-brand-primary text-xl hidden">ف</span>
                </div>
                <h1 class="text-xl md:text-2xl font-bold text-white">
                    دار فريدة <span class="text-brand-gold text-sm font-light mr-1">كوكب التراث</span>
                </h1>
            </div>
            <button onclick="renderDashboard()" class="p-2 rounded-lg text-brand-gold hover:bg-white/10 transition-colors flex items-center gap-2">
                <i data-lucide="home" class="w-5 h-5"></i>
                <span class="hidden md:inline">الرئيسية</span>
            </button>
        </div>
    </header>

    <!-- المحتوى الرئيسي -->
    <main id="app" class="container mx-auto px-4"></main>

    <!-- منطقة الطباعة المخفية -->
    <div id="printable-area" class="hidden"></div>

    <script>
        // --- إدارة الحالة (State) ---
        let contracts = JSON.parse(localStorage.getItem('dar_farida_contracts')) || [];
        let currentView = 'dashboard';
        let selectedContractId = null;
        let editingContractId = null;

        // حفظ البيانات
        function saveContracts() {
            localStorage.setItem('dar_farida_contracts', JSON.stringify(contracts));
        }

        // --- أدوات مساعدة ---
        const formatCurrency = (amount) => {
            const val = new Intl.NumberFormat('ar-SA', { 
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0 
            }).format(amount);
            // استخدام شعار الريال السعودي كصورة
            return `<span style="white-space: nowrap;">${val} <img src="https://upload.wikimedia.org/wikipedia/commons/9/98/Saudi_Riyal_Symbol.svg" style="height: 14px; display: inline-block; vertical-align: middle; margin-right: 2px;" alt="ر.س"></span>`;
        };
        
        const calculateDays = (start, end) => {
            const diff = Math.abs(new Date(end) - new Date(start));
            const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
            return days === 0 ? 1 : days;
        };

        const getStatusHTML = (status) => {
            const config = {
                active: { color: 'bg-brand-success', text: 'نشط / مؤجر' },
                closed: { color: 'bg-brand-primary', text: 'مكتمل' },
                late: { color: 'bg-brand-accent', text: 'متأخر' }
            };
            const s = config[status] || { color: 'bg-gray-500', text: status };
            return `<span class="px-3 py-1 rounded-full text-xs font-bold text-white ${s.color}">${s.text}</span>`;
        };

        // --- دوال العرض (Render Functions) ---

        function renderDashboard() {
            currentView = 'dashboard';
            editingContractId = null;
            const activeCount = contracts.filter(c => c.status === 'active').length;
            const totalRevenue = contracts.reduce((acc, c) => acc + c.totalRent + (c.finalBill ? (c.finalBill.lateFee + c.finalBill.damageFee) : 0), 0);

            const html = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 fade-in">
                    <div class="p-6 rounded-xl shadow-md bg-white border-r-4 border-brand-gold hover:-translate-y-1 transition-transform">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-brand-primary">العقود النشطة</h3>
                            <i data-lucide="shopping-bag" class="text-brand-success"></i>
                        </div>
                        <p class="text-3xl font-bold text-brand-text">${activeCount}</p>
                    </div>

                    <div class="p-6 rounded-xl shadow-md bg-white border-r-4 border-brand-accent hover:-translate-y-1 transition-transform">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-brand-primary">إجمالي الإيرادات</h3>
                            <i data-lucide="dollar-sign" class="text-brand-gold"></i>
                        </div>
                        <p class="text-3xl font-bold text-brand-text" dir="ltr">${formatCurrency(totalRevenue)}</p>
                    </div>

                    <button onclick="renderNewContract()" class="p-6 rounded-xl shadow-md bg-brand-primary flex flex-col items-center justify-center gap-3 hover:scale-105 transition-transform group cursor-pointer">
                        <div class="p-3 rounded-full bg-white/10 group-hover:bg-white/20">
                            <i data-lucide="plus" class="w-8 h-8 text-brand-gold"></i>
                        </div>
                        <span class="text-lg font-bold text-white">عقد إيجار جديد</span>
                    </button>

                    <button onclick="renderContractList()" class="p-6 rounded-xl shadow-md bg-white border-2 border-brand-primary flex flex-col items-center justify-center gap-3 hover:scale-105 transition-transform group cursor-pointer">
                        <div class="p-3 rounded-full bg-brand-bg">
                            <i data-lucide="search" class="w-8 h-8 text-brand-primary"></i>
                        </div>
                        <span class="text-lg font-bold text-brand-primary">سجل العقود</span>
                    </button>
                </div>
            `;
            document.getElementById('app').innerHTML = html;
            lucide.createIcons();
        }

        function renderEditContract(id) {
            editingContractId = id;
            renderNewContract();
        }

        function renderNewContract() {
            currentView = 'new-contract';
            const today = new Date().toISOString().split('T')[0];
            
            let initialData = {
                clientName: '',
                clientPhone: '',
                startDate: today,
                returnDate: '',
                contractDailyRent: '',
                totalDeposit: '',
                items: []
            };

            if (editingContractId) {
                const contract = contracts.find(c => c.id === editingContractId);
                if (contract) {
                    initialData = {
                        clientName: contract.clientName,
                        clientPhone: contract.clientPhone,
                        startDate: contract.startDate,
                        returnDate: contract.returnDate,
                        contractDailyRent: contract.dailyRent,
                        totalDeposit: contract.totalDeposit,
                        items: contract.items
                    };
                }
            }
            
            const titleText = editingContractId ? "تعديل بيانات العقد" : "إنشاء عقد جديد";
            const btnText = editingContractId ? "حفظ التعديلات" : "اعتماد العقد";

            const html = `
                <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden slide-up">
                    <div class="p-6 border-b bg-brand-primary flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-white flex items-center gap-2 font-heading">
                            <i data-lucide="${editingContractId ? 'edit' : 'file-text'}" class="text-brand-gold"></i> ${titleText}
                        </h2>
                        ${editingContractId ? `<span class="bg-brand-gold text-brand-primary px-3 py-1 rounded text-sm font-bold">عقد #${editingContractId.slice(-6)}</span>` : ''}
                    </div>
                    
                    <form id="contractForm" onsubmit="handleContractSubmit(event)" class="p-6 space-y-8">
                        <section>
                            <h3 class="text-lg font-bold mb-4 flex items-center gap-2 text-brand-accent">
                                <i data-lucide="user"></i> بيانات العميل
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1 text-gray-700">اسم العميل</label>
                                    <input type="text" name="clientName" value="${initialData.clientName}" required class="w-full p-3 rounded-lg border border-brand-primary bg-[#FAF9F6] focus:ring-2 focus:outline-none" placeholder="الاسم الثلاثي">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1 text-gray-700">رقم الجوال</label>
                                    <input type="tel" name="clientPhone" value="${initialData.clientPhone}" required class="w-full p-3 rounded-lg border border-brand-primary bg-[#FAF9F6] focus:ring-2 focus:outline-none" placeholder="05xxxxxxxx">
                                </div>
                            </div>
                        </section>

                        <section>
                            <h3 class="text-lg font-bold mb-4 flex items-center gap-2 text-brand-accent">
                                <i data-lucide="calendar"></i> بيانات العقد والتواريخ
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <div>
                                    <label class="block text-sm font-medium mb-1 text-brand-primary font-bold">الإيجار اليومي (الموحد)</label>
                                    <input type="number" name="contractDailyRent" value="${initialData.contractDailyRent}" required min="1" step="1" class="w-full p-3 rounded-lg border border-brand-gold bg-white focus:ring-2 focus:outline-none" placeholder="سعر اليوم">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1 text-brand-accent font-bold">إجمالي التأمين (للكل)</label>
                                    <input type="number" name="contractTotalDeposit" value="${initialData.totalDeposit}" required min="0" step="1" class="w-full p-3 rounded-lg border border-brand-accent bg-white focus:ring-2 focus:outline-none" placeholder="التأمين الشامل">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1 text-gray-700">تاريخ الاستلام</label>
                                    <input type="date" name="startDate" value="${initialData.startDate}" required class="w-full p-3 rounded-lg border border-gray-300 bg-white">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1 text-gray-700">تاريخ الإرجاع</label>
                                    <input type="date" name="returnDate" value="${initialData.returnDate || ''}" min="${today}" required class="w-full p-3 rounded-lg border border-gray-300 bg-white">
                                </div>
                            </div>
                        </section>

                        <section>
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold flex items-center gap-2 text-brand-accent">
                                    <i data-lucide="shopping-bag"></i> تفاصيل القطع
                                </h3>
                                <button type="button" onclick="addItemRow()" class="px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 bg-brand-success text-white hover:opacity-90">
                                    <i data-lucide="plus" class="w-4 h-4"></i> إضافة قطعة
                                </button>
                            </div>
                            
                            <div class="hidden md:grid grid-cols-12 gap-4 mb-2 text-sm text-gray-500 font-bold px-4">
                                <div class="col-span-8">الوصف / اسم القطعة</div>
                                <div class="col-span-3">العدد</div>
                                <div class="col-span-1"></div>
                            </div>

                            <div id="itemsContainer" class="space-y-4 mb-4">
                                <div class="text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 text-gray-500" id="emptyItemsMsg">
                                    لم يتم إضافة قطع بعد.
                                </div>
                            </div>
                        </section>

                        <section class="pt-4 border-t">
                            <div class="bg-gray-50 p-4 rounded-lg mb-4 border border-brand-primary/20">
                                <h4 class="font-bold text-brand-primary mb-2 text-sm">شروط وأحكام الإيجار:</h4>
                                <ol class="list-decimal list-inside text-xs md:text-sm text-gray-700 space-y-1">
                                    <li>يقر المستأجر باستلام القطعة بحالة سليمة وخالية من العيوب.</li>
                                    <li>في حال التلف، التمزق، الاتساخ غير القابل للتنظيف، أو فقدان أي جزء (إكسسوار / حزام / غطاء رأس): يحق للمحل خصم كامل مبلغ التأمين أو مطالبة المستأجر بقيمة القطعة كاملة حسب تقدير المحل.</li>
                                    <li>يمنع غسل أو تعديل أو قص القطعة أو استخدام مواد تجميلية تسبب بقع (مكياج – عطور مباشرة).</li>
                                    <li>التأخير في الإرجاع يترتب عليه غرامة يومية تعادل قيمة الإيجار اليومي عن كل يوم تأخير.</li>
                                    <li>في حال الفقدان الكامل، يلتزم المستأجر بدفع القيمة السوقية للقطعة دون اعتراض.</li>
                                    <li>لا يحق للمستأجر تأجير القطعة لطرف آخر.</li>
                                    <li>مبلغ التأمين يُسترد بعد فحص القطعة.</li>
                                    <li>هذه الفاتورة تعتبر عقدًا ملزمًا للطرفين.</li>
                                </ol>
                            </div>

                            <label class="flex items-center gap-3 cursor-pointer p-4 rounded-lg hover:bg-gray-50">
                                <input type="checkbox" id="termsCheck" required class="w-5 h-5 text-brand-primary rounded" ${editingContractId ? 'checked' : ''}>
                                <span class="text-sm md:text-base font-bold text-brand-primary">
                                    أقر وأوافق على جميع الشروط والأحكام المذكورة أعلاه.
                                </span>
                            </label>

                            <div class="flex justify-end gap-4 mt-6">
                                <button type="button" onclick="${editingContractId ? `renderContractDetails('${editingContractId}')` : 'renderDashboard()'}" class="px-6 py-3 rounded-lg font-bold border hover:bg-gray-50 text-gray-600">إلغاء</button>
                                <button type="submit" class="px-8 py-3 rounded-lg font-bold text-white bg-brand-primary flex items-center gap-2 shadow-lg hover:scale-105 transition-transform">
                                    <i data-lucide="save"></i> ${btnText}
                                </button>
                            </div>
                        </section>
                    </form>
                </div>
            `;
            document.getElementById('app').innerHTML = html;
            
            if (initialData.items && initialData.items.length > 0) {
                document.getElementById('emptyItemsMsg')?.remove();
                initialData.items.forEach(item => addItemRow(item));
            }

            lucide.createIcons();
        }

        function addItemRow(data = null) {
            document.getElementById('emptyItemsMsg')?.remove();
            const container = document.getElementById('itemsContainer');
            const id = Date.now() + Math.random();
            const div = document.createElement('div');
            div.className = "p-4 rounded-lg border relative grid grid-cols-1 md:grid-cols-12 gap-4 items-end bg-gray-50 fade-in item-row";
            div.dataset.id = id;
            
            const nameValue = data ? data.name : '';
            const qtyValue = data ? data.quantity : 1;

            div.innerHTML = `
                <div class="md:col-span-8 w-full">
                    <label class="text-xs text-gray-500 md:hidden">الوصف</label>
                    <input type="text" class="item-name w-full p-2 border rounded" placeholder="اسم المنتج" value="${nameValue}" required>
                </div>
                <div class="md:col-span-3 w-full">
                    <label class="text-xs text-gray-500 md:hidden">العدد</label>
                    <input type="number" class="item-qty w-full p-2 border rounded" min="1" value="${qtyValue}" required>
                </div>
                <div class="md:col-span-1 w-full flex justify-end">
                    <button type="button" onclick="this.closest('.item-row').remove()" class="p-2 text-red-500 hover:bg-red-50 rounded">
                        <i data-lucide="trash-2"></i>
                    </button>
                </div>
            `;
            container.appendChild(div);
            lucide.createIcons();
        }

        function handleContractSubmit(e) {
            e.preventDefault();
            const form = e.target;
            
            const itemRows = document.querySelectorAll('.item-row');
            if (itemRows.length === 0) {
                alert('يرجى إضافة قطعة واحدة على الأقل');
                return;
            }

            const items = Array.from(itemRows).map(row => ({
                id: row.dataset.id,
                name: row.querySelector('.item-name').value,
                quantity: Number(row.querySelector('.item-qty').value),
            }));

            const startDate = form.startDate.value;
            const returnDate = form.returnDate.value;
            const rentalDays = calculateDays(startDate, returnDate);
            const contractDailyRent = Number(form.contractDailyRent.value);
            const contractTotalDeposit = Number(form.contractTotalDeposit.value);

            const totalRent = contractDailyRent * rentalDays;

            const contractData = {
                clientName: form.clientName.value,
                clientPhone: form.clientPhone.value,
                startDate,
                returnDate,
                items,
                dailyRent: contractDailyRent,
                totalRent,
                totalDeposit: contractTotalDeposit,
                rentalDays,
                status: editingContractId ? (contracts.find(c => c.id === editingContractId).status) : 'active',
                createdAt: editingContractId ? (contracts.find(c => c.id === editingContractId).createdAt) : new Date().toISOString(),
                finalBill: editingContractId ? (contracts.find(c => c.id === editingContractId).finalBill) : null
            };

            if (editingContractId) {
                const index = contracts.findIndex(c => c.id === editingContractId);
                if (index !== -1) {
                    contracts[index] = { ...contracts[index], ...contractData };
                }
                selectedContractId = editingContractId;
                editingContractId = null;
            } else {
                const newContract = {
                    id: Date.now().toString(),
                    ...contractData
                };
                contracts.unshift(newContract);
            }

            saveContracts();
            
            if (selectedContractId) {
                renderContractDetails(selectedContractId);
            } else {
                renderContractList();
            }
        }

        function renderContractList(filter = '') {
            currentView = 'list';
            editingContractId = null;
            const filtered = contracts.filter(c => 
                c.clientName.includes(filter) || c.id.includes(filter)
            ).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            const html = `
                <div class="fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h2 class="text-2xl font-bold text-brand-primary font-heading">سجل العقود</h2>
                        <div class="relative w-full md:w-96">
                            <i data-lucide="search" class="absolute right-3 top-3 text-gray-400 w-5 h-5"></i>
                            <input type="text" onkeyup="renderContractList(this.value)" 
                                placeholder="بحث..." 
                                class="w-full pr-10 pl-4 py-3 rounded-lg border border-brand-gold shadow-sm focus:outline-none focus:ring-2">
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-md overflow-hidden overflow-x-auto">
                        <table class="w-full text-right min-w-[600px]">
                            <thead class="bg-gray-50 text-gray-600 font-medium border-b">
                                <tr>
                                    <th class="p-4">رقم العقد</th>
                                    <th class="p-4">العميل</th>
                                    <th class="p-4">تاريخ الإرجاع</th>
                                    <th class="p-4">الحالة</th>
                                    <th class="p-4">الإجمالي</th>
                                    <th class="p-4">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${filtered.length === 0 ? '<tr><td colspan="6" class="p-8 text-center text-gray-500">لا توجد نتائج</td></tr>' : 
                                  filtered.map(c => `
                                    <tr class="hover:bg-amber-50 transition-colors">
                                        <td class="p-4 font-mono text-sm">#${c.id.slice(-6)}</td>
                                        <td class="p-4 font-bold text-brand-primary">${c.clientName}</td>
                                        <td class="p-4">${c.returnDate}</td>
                                        <td class="p-4">${getStatusHTML(c.status)}</td>
                                        <td class="p-4 font-bold">${formatCurrency(c.totalRent)}</td>
                                        <td class="p-4">
                                            <button onclick="renderContractDetails('${c.id}')" class="px-4 py-2 rounded-lg text-sm font-bold border border-brand-primary text-brand-primary hover:bg-gray-100">
                                                تفاصيل
                                            </button>
                                        </td>
                                    </tr>
                                  `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            document.getElementById('app').innerHTML = html;
            lucide.createIcons();
        }

        function renderContractDetails(id) {
            currentView = 'details';
            selectedContractId = id;
            const contract = contracts.find(c => c.id === id);
            if (!contract) return;

            const isClosed = contract.status === 'closed';
            const today = new Date().toISOString().split('T')[0];
            const dailyRentTotal = contract.dailyRent !== undefined ? contract.dailyRent : 
                contract.items.reduce((acc, item) => acc + (item.price * item.quantity), 0);

            // تجميع أنواع التلف إذا كانت موجودة
            let damageDetailsHtml = '';
            if (isClosed && contract.finalBill && contract.finalBill.damageDetails) {
                 const details = contract.finalBill.damageDetails;
                 damageDetailsHtml = `
                    <div class="mt-2 text-sm text-red-700 border-t border-red-200 pt-2">
                        ${details.types.length > 0 ? `<p class="font-bold">نوع التلف: ${details.types.join('، ')}</p>` : ''}
                        ${details.description ? `<p>ملاحظات: ${details.description}</p>` : ''}
                    </div>
                 `;
            }

            let html = `
                <div class="slide-up">
                    <button onclick="renderContractList()" class="mb-4 flex items-center text-gray-600 hover:text-gray-900">
                        <i data-lucide="chevron-right" class="w-5 h-5 ml-1"></i> عودة للقائمة
                    </button>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 space-y-6">
                            <div class="bg-white rounded-xl shadow-md p-6 border-t-4 border-brand-gold">
                                <div class="flex justify-between items-start mb-6">
                                    <div>
                                        <h2 class="text-2xl font-bold mb-1 text-brand-primary">عقد #${contract.id.slice(-6)}</h2>
                                        <p class="text-gray-500 flex items-center gap-2"><i data-lucide="user" class="w-4 h-4"></i> ${contract.clientName}</p>
                                        <p class="text-gray-500 flex items-center gap-2"><i data-lucide="phone" class="w-4 h-4"></i> ${contract.clientPhone}</p>
                                    </div>
                                    <div class="text-center">
                                        ${getStatusHTML(contract.status)}
                                        <div class="text-xs text-gray-500 mt-1">${contract.rentalDays} أيام</div>
                                        ${!isClosed ? `<button onclick="renderEditContract('${contract.id}')" class="mt-2 text-xs bg-brand-primary text-white px-2 py-1 rounded hover:opacity-80 flex items-center gap-1 mx-auto"><i data-lucide="edit" class="w-3 h-3"></i> تعديل</button>` : ''}
                                    </div>
                                </div>

                                <div class="space-y-4">
                                    <h3 class="font-bold border-b pb-2 text-brand-accent">المنتجات</h3>
                                    ${contract.items.map(item => `
                                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                            <div class="flex items-center gap-3">
                                                <span class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold bg-brand-gold">${item.quantity}</span>
                                                <span class="font-medium text-gray-800">${item.name}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <div class="mt-6 pt-4 border-t flex justify-between items-center text-sm">
                                    <div><span class="text-gray-500">استلام:</span> <b>${contract.startDate}</b></div>
                                    <i data-lucide="arrow-left" class="text-gray-400"></i>
                                    <div><span class="text-gray-500">إرجاع:</span> <b>${contract.returnDate}</b></div>
                                </div>
                            </div>

                            ${!isClosed ? `
                                <div class="bg-white rounded-xl shadow-md p-6 border-t-4 border-brand-accent">
                                    <h3 class="text-xl font-bold mb-4 flex items-center gap-2 text-brand-accent">
                                        <i data-lucide="check-circle"></i> إجراءات الإرجاع
                                    </h3>
                                    
                                    <div class="mb-4 bg-amber-50 p-3 rounded border border-amber-200 text-sm flex gap-2 items-start">
                                        <i data-lucide="info" class="w-5 h-5 text-amber-600 shrink-0 mt-0.5"></i>
                                        <div>
                                            <span class="block font-bold text-brand-primary mb-1">سياسة الغرامات:</span>
                                            يتم احتساب غرامة تأخير يومية تعادل قيمة الإيجار اليومي (<span class="font-bold">${formatCurrency(dailyRentTotal)}</span>).
                                        </div>
                                    </div>

                                    <form onsubmit="handleReturn(event)" class="space-y-4">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium mb-1">تاريخ الإرجاع الفعلي</label>
                                                <input type="date" id="actualReturnDate" value="${today}" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-brand-accent focus:outline-none" required onchange="calculatePreviewLateFee(this.value, ${dailyRentTotal}, '${contract.returnDate}')">
                                            </div>
                                            <div id="lateFeePreview" class="hidden md:flex flex-col justify-center bg-gray-50 p-3 rounded border">
                                                <span class="text-xs text-gray-500">حالة التأخير (محسوبة تلقائياً):</span>
                                                <span class="font-bold text-brand-success" id="lateFeeText">لا يوجد تأخير</span>
                                            </div>
                                        </div>
                                        
                                        <div class="border-t pt-4 mt-2">
                                            <label class="block text-sm font-medium mb-3">فحص حالة المنتجات المسترجعة</label>
                                            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                                                <label class="flex-1 border rounded-lg p-3 cursor-pointer hover:bg-gray-50 flex items-center gap-2 transition-colors has-[:checked]:border-brand-success has-[:checked]:bg-green-50">
                                                    <input type="radio" name="condition" value="good" checked onchange="toggleDamageInput(false)" class="w-4 h-4 text-brand-success accent-brand-success">
                                                    <div>
                                                        <span class="block font-bold text-sm">سليم (بالحالة الأصلية)</span>
                                                        <span class="text-xs text-gray-500">لا توجد رسوم إضافية</span>
                                                    </div>
                                                </label>
                                                <label class="flex-1 border rounded-lg p-3 cursor-pointer hover:bg-gray-50 flex items-center gap-2 transition-colors has-[:checked]:border-red-500 has-[:checked]:bg-red-50">
                                                    <input type="radio" name="condition" value="damaged" onchange="toggleDamageInput(true)" class="w-4 h-4 text-red-600 accent-red-600">
                                                    <div>
                                                        <span class="block font-bold text-sm text-red-700">تالف / ملاحظات</span>
                                                        <span class="text-xs text-gray-500">يتطلب تقدير تكلفة</span>
                                                    </div>
                                                </label>
                                            </div>

                                            <div id="damageInputContainer" class="hidden fade-in space-y-3 bg-red-50 p-4 rounded-lg border border-red-100">
                                                <div>
                                                    <label class="block text-xs font-bold text-red-800 mb-2">نوع التلف / الملاحظة (اختر ما ينطبق):</label>
                                                    <div class="flex flex-wrap gap-2">
                                                        ${['كسر', 'بقع', 'تعديل', 'غسيل', 'مفقود', 'قطع، تمزيق'].map(t => `
                                                            <label class="inline-flex items-center gap-1 bg-white px-3 py-1 rounded border cursor-pointer hover:bg-gray-50">
                                                                <input type="checkbox" name="damageType" value="${t}" class="text-red-600 rounded">
                                                                <span class="text-sm">${t}</span>
                                                            </label>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                                
                                                <div>
                                                    <label class="block text-xs font-bold text-red-800 mb-1">وصف إضافي للتلف:</label>
                                                    <textarea id="damageDesc" class="w-full p-2 border rounded text-sm" placeholder="اكتب تفاصيل التلف هنا..."></textarea>
                                                </div>

                                                <div>
                                                    <label class="block text-xs font-bold text-red-800 mb-1">تقدير قيمة التلف / الغرامة:</label>
                                                    <div class="relative">
                                                        <input type="number" id="damageFee" value="0" min="0" step="1" class="w-full p-2 border border-red-300 rounded focus:ring-2 focus:ring-red-500 focus:outline-none">
                                                        <span class="absolute left-3 top-2 text-gray-400 text-sm">ر.س</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <button type="submit" class="w-full py-3 rounded-lg font-bold text-white bg-brand-success hover:opacity-90 shadow-lg mt-6">
                                            تأكيد الإرجاع وإغلاق العقد
                                        </button>
                                    </form>
                                </div>
                            ` : `
                                <div class="bg-gray-100 rounded-xl p-6 text-center border-2 border-dashed border-gray-300">
                                    <div class="inline-block p-3 rounded-full bg-gray-200 mb-3">
                                        <i data-lucide="archive" class="w-6 h-6 text-gray-600"></i>
                                    </div>
                                    <p class="text-gray-800 font-bold mb-1">تم إغلاق هذا العقد</p>
                                    <p class="text-sm text-gray-500">تاريخ الإرجاع: ${contract.actualReturnDate}</p>
                                    ${damageDetailsHtml}
                                </div>
                            `}
                        </div>

                        <div class="lg:col-span-1">
                            <div class="bg-white rounded-xl shadow-md p-6 sticky top-24">
                                <h3 class="text-lg font-bold mb-4 text-gray-800">الملخص المالي</h3>
                                <div class="space-y-3 mb-6">
                                    <div class="flex justify-between text-gray-600">
                                        <span>قيمة الإيجار اليومي</span>
                                        <span class="font-bold">${formatCurrency(dailyRentTotal)}</span>
                                    </div>
                                    <div class="flex justify-between text-brand-primary">
                                        <span>إجمالي الإيجار (${contract.rentalDays} أيام)</span>
                                        <span class="font-bold">${formatCurrency(contract.totalRent)}</span>
                                    </div>
                                    <div class="flex justify-between text-gray-600 pb-3 border-b border-dashed">
                                        <span>إجمالي التأمين المدفوع</span>
                                        <span class="font-bold">${formatCurrency(contract.totalDeposit)}</span>
                                    </div>
                                    ${isClosed && contract.finalBill ? `
                                        <div class="text-red-600 text-sm space-y-1">
                                            ${contract.finalBill.lateDays > 0 ? `<div class="flex justify-between"><span>تأخير (${contract.finalBill.lateDays} يوم)</span><span>- ${formatCurrency(contract.finalBill.lateFee)}</span></div>` : ''}
                                            ${contract.finalBill.damageFee > 0 ? `<div class="flex justify-between"><span>تلفيات</span><span>- ${formatCurrency(contract.finalBill.damageFee)}</span></div>` : ''}
                                        </div>
                                        <div class="pt-3 border-t-2 border-gray-800 flex justify-between items-center mt-2">
                                            <span class="font-bold text-brand-primary">المسترد للعميل</span>
                                            <span class="font-bold text-xl text-brand-success">${formatCurrency(contract.finalBill.amountToReturnToClient)}</span>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="space-y-2">
                                    <button onclick="printInvoice('${contract.id}', 'rental')" class="w-full py-3 border-2 border-gray-300 rounded-lg flex items-center justify-center gap-2 hover:bg-gray-50 font-bold text-gray-700 bg-white transition-colors">
                                        <i data-lucide="file-text"></i> طباعة عقد الإيجار
                                    </button>
                                    ${isClosed ? `
                                        <button onclick="printInvoice('${contract.id}', 'return')" class="w-full py-3 rounded-lg flex items-center justify-center gap-2 hover:opacity-90 font-bold text-white bg-brand-primary transition-colors">
                                            <i data-lucide="check-circle"></i> طباعة فاتورة الإرجاع
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('app').innerHTML = html;
            lucide.createIcons();
            
            if (!isClosed) {
                calculatePreviewLateFee(today, dailyRentTotal, contract.returnDate);
            }
        }

        function toggleDamageInput(show) {
            const container = document.getElementById('damageInputContainer');
            const input = document.getElementById('damageFee');
            if (show) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
                input.value = 0;
                document.querySelectorAll('input[name="damageType"]').forEach(cb => cb.checked = false);
                document.getElementById('damageDesc').value = '';
            }
        }

        function calculatePreviewLateFee(actualDateStr, dailyRate, plannedDateStr) {
            const actualDate = new Date(actualDateStr);
            const plannedDate = new Date(plannedDateStr);
            const previewEl = document.getElementById('lateFeeText');
            const containerEl = document.getElementById('lateFeePreview');
            
            if (!previewEl) return;
            
            containerEl.classList.remove('hidden');
            containerEl.classList.add('flex');

            if (actualDate > plannedDate) {
                const diffTime = Math.abs(actualDate - plannedDate);
                const lateDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                const fine = lateDays * dailyRate;
                
                previewEl.innerHTML = `تأخير ${lateDays} يوم <br> غرامة: ${formatCurrency(fine)}`;
                previewEl.className = "font-bold text-red-600 text-center leading-tight";
            } else {
                previewEl.textContent = "لا يوجد تأخير (ضمن المدة)";
                previewEl.className = "font-bold text-brand-success";
            }
        }

        function handleReturn(e) {
            e.preventDefault();
            const contract = contracts.find(c => c.id === selectedContractId);
            const actualDate = new Date(document.getElementById('actualReturnDate').value);
            const plannedDate = new Date(contract.returnDate);
            
            const damageInput = document.getElementById('damageFee');
            const damageFee = damageInput ? Number(damageInput.value) : 0;
            
            // جمع تفاصيل التلف
            const damageTypes = Array.from(document.querySelectorAll('input[name="damageType"]:checked')).map(cb => cb.value);
            const damageDesc = document.getElementById('damageDesc') ? document.getElementById('damageDesc').value : '';

            const dailyRentTotal = contract.dailyRent !== undefined ? contract.dailyRent : 
                contract.items.reduce((acc, item) => acc + (item.price * item.quantity), 0);

            let lateDays = 0;
            if (actualDate > plannedDate) {
                const diff = Math.abs(actualDate - plannedDate);
                lateDays = Math.ceil(diff / (1000 * 60 * 60 * 24));
            }

            const lateFee = lateDays * dailyRentTotal;
            const totalDeductions = lateFee + damageFee;
            const amountToReturnToClient = contract.totalDeposit - totalDeductions;

            contract.status = 'closed';
            contract.actualReturnDate = document.getElementById('actualReturnDate').value;
            contract.finalBill = { 
                lateDays, 
                lateFee, 
                damageFee, 
                totalDeductions, 
                amountToReturnToClient,
                damageDetails: {
                    types: damageTypes,
                    description: damageDesc
                }
            };

            saveContracts();
            renderContractDetails(selectedContractId);
        }

        function printInvoice(id, type) {
            const contract = contracts.find(c => c.id === id);
            const printArea = document.getElementById('printable-area');
            const dailyRentTotal = contract.dailyRent !== undefined ? contract.dailyRent : 
                contract.items.reduce((acc, item) => acc + (item.price * item.quantity), 0);
            
            // تحديد نوع الطباعة (إيجار أو إرجاع)
            const isReturnInvoice = type === 'return';
            const docTitle = isReturnInvoice ? 'فاتورة إرجاع / مخالصة نهائية' : 'عقد إيجار';
            const docDate = isReturnInvoice && contract.actualReturnDate ? contract.actualReturnDate : new Date().toISOString().split('T')[0];

            let itemsHtml = contract.items.map(item => `
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 8px;">${item.name}</td>
                    <td style="padding: 8px;">${item.quantity}</td>
                </tr>
            `).join('');

            // تجهيز نص التلف للطباعة (فقط في فاتورة الإرجاع)
            let damageHtml = '';
            if (isReturnInvoice && contract.finalBill) {
                const bill = contract.finalBill;
                const hasDamage = bill.damageFee > 0 || (bill.damageDetails && bill.damageDetails.types.length > 0);
                
                if (hasDamage) {
                    const details = bill.damageDetails || { types: [], description: '' };
                    damageHtml = `
                        <div style="background: #fff0f0; border: 1px solid #ffcccc; padding: 10px; margin-top: 10px; border-radius: 5px;">
                            <h4 style="margin: 0 0 5px 0; color: #c00;">تفاصيل التلف:</h4>
                            <div style="font-size: 12px; color: #333;">
                                ${details.types.length > 0 ? `<div><strong>نوع التلف:</strong> ${details.types.join('، ')}</div>` : ''}
                                ${details.description ? `<div><strong>ملاحظات:</strong> ${details.description}</div>` : ''}
                                <div style="margin-top: 5px;"><strong>قيمة الغرامة:</strong> ${formatCurrency(bill.damageFee)}</div>
                            </div>
                        </div>
                    `;
                }
            }

            printArea.innerHTML = `
                <div style="text-align: center; border-bottom: 2px solid #5C3A21; padding-bottom: 10px; margin-bottom: 20px;">
                    <img src="icon.jpeg" style="width: 70px; height: 70px; object-fit: cover; border-radius: 50%; margin-bottom: 5px;" onerror="this.style.display='none'">
                    <h1 style="font-size: 24px; color: #5C3A21; margin: 0;">دار فريدة كوكب التراث</h1>
                    <h2 style="font-size: 18px; margin-top: 5px; color: #333; text-decoration: underline;">${docTitle}</h2>
                    <div style="display: flex; justify-content: space-between; margin-top: 15px; font-size: 12px; font-weight: bold;">
                        <span>رقم العقد: #${contract.id.slice(-6)}</span>
                        <span>تاريخ الطباعة: ${new Date().toLocaleDateString('ar-SA')}</span>
                    </div>
                </div>

                <div style="display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 12px;">
                    <div style="width: 48%;">
                        <h3 style="border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-bottom: 5px;">بيانات العميل</h3>
                        <p>الاسم: <b>${contract.clientName}</b></p>
                        <p>الجوال: <b>${contract.clientPhone}</b></p>
                    </div>
                    <div style="width: 48%;">
                        <h3 style="border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-bottom: 5px;">تواريخ العقد</h3>
                        <p>تاريخ الاستلام: <b>${contract.startDate}</b></p>
                        <p>تاريخ الإرجاع المتوقع: <b>${contract.returnDate}</b></p>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="font-size: 14px; font-weight: bold; margin-bottom: 10px; background: #eee; padding: 5px;">تفاصيل القطع والمالية</h3>
                    <table style="width: 100%; text-align: right; border-collapse: collapse; font-size: 12px; margin-bottom: 10px;">
                        <thead>
                            <tr style="background: #f9f9f9; border-bottom: 1px solid #999;">
                                <th style="padding: 8px;">المنتج</th>
                                <th style="padding: 8px;">العدد</th>
                            </tr>
                        </thead>
                        <tbody>${itemsHtml}</tbody>
                    </table>
                    
                    <div style="display: flex; justify-content: space-between; background: #fdfdfd; padding: 10px; border: 1px solid #eee;">
                        <div>الإيجار اليومي: <b>${formatCurrency(dailyRentTotal)}</b></div>
                        <div>إجمالي التأمين: <b>${formatCurrency(contract.totalDeposit)}</b></div>
                    </div>
                </div>

                ${isReturnInvoice && contract.finalBill ? `
                    <div style="margin-top: 20px; border: 1px solid #333; padding: 15px; border-radius: 5px;">
                        <h3 style="font-size: 14px; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px;">فحص الإرجاع والتسوية</h3>
                        
                        <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 10px;">
                            <span>تاريخ الإرجاع الفعلي: <b>${contract.actualReturnDate}</b></span>
                            <span>حالة المنتجات: <b>${(contract.finalBill.damageFee > 0) ? 'تالف / ملاحظات' : 'سليم'}</b></span>
                        </div>

                        ${damageHtml}

                        <div style="margin-top: 15px; padding-top: 10px; border-top: 1px dashed #999;">
                            ${contract.finalBill.lateDays > 0 ? `<div style="display: flex; justify-content: space-between; color: #c00;"><span>غرامة تأخير (${contract.finalBill.lateDays} يوم):</span><span>-${formatCurrency(contract.finalBill.lateFee)}</span></div>` : ''}
                            ${contract.finalBill.damageFee > 0 ? `<div style="display: flex; justify-content: space-between; color: #c00;"><span>خصم التلفيات:</span><span>-${formatCurrency(contract.finalBill.damageFee)}</span></div>` : ''}
                            
                            <div style="display: flex; justify-content: space-between; font-size: 16px; font-weight: bold; margin-top: 10px; background: #eaffea; padding: 10px; border: 1px solid #4caf50;">
                                <span>صافي المبلغ المسترد للعميل:</span>
                                <span>${formatCurrency(contract.finalBill.amountToReturnToClient)}</span>
                            </div>
                        </div>
                    </div>
                ` : ''}

                ${!isReturnInvoice ? `
                <div style="margin-top: 30px; font-size: 10px; color: #444; border-top: 1px solid #ddd; padding-top: 10px;">
                    <h4 style="margin-bottom: 5px; font-weight: bold;">شروط وأحكام الإيجار:</h4>
                    <ol style="padding-right: 15px; margin: 0; line-height: 1.4;">
                        <li>يقر المستأجر باستلام القطعة بحالة سليمة وخالية من العيوب.</li>
                        <li>في حال التلف، التمزق، الاتساخ غير القابل للتنظيف، أو فقدان أي جزء (إكسسوار / حزام / غطاء رأس): يحق للمحل خصم كامل مبلغ التأمين أو مطالبة المستأجر بقيمة القطعة كاملة حسب تقدير المحل.</li>
                        <li>يمنع غسل أو تعديل أو قص القطعة أو استخدام مواد تجميلية تسبب بقع (مكياج – عطور مباشرة).</li>
                        <li>التأخير في الإرجاع يترتب عليه غرامة يومية تعادل قيمة الإيجار اليومي عن كل يوم تأخير.</li>
                        <li>في حال الفقدان الكامل، يلتزم المستأجر بدفع القيمة السوقية للقطعة دون اعتراض.</li>
                        <li>لا يحق للمستأجر تأجير القطعة لطرف آخر.</li>
                        <li>مبلغ التأمين يُسترد بعد فحص القطعة.</li>
                        <li>هذه الفاتورة تعتبر عقدًا ملزمًا للطرفين.</li>
                    </ol>
                </div>
                ` : ''}

                <div style="position: fixed; bottom: 0; left: 0; width: 100%; text-align: center; font-size: 10px; color: #888; border-top: 1px solid #eee; padding-top: 5px;">
                    <p>شكراً لثقتكم بدار فريدة كوكب التراث</p>
                </div>
            `;

            window.print();
        }

        renderDashboard();
    </script>
</body>
</html>
